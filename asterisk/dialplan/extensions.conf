[general]
static=yes
writeprotect=no
clearglobalvars=no


; ==================================================
; CONTEXTO PRINCIPAL - RAMAIS INTERNOS
; ==================================================
[from-internal]

; ---------- CHAMADAS ENTRE RAMAIS ----------
exten => _1XXX,1,NoOp(Chamada direta para ramal ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},20)
 same => n,Hangup()

; ---------- ACESSO À FILA ----------
exten => 600,1,Goto(fila-atendimento,s,1)



; ==================================================
; CONTEXTO DA FILA
; ==================================================
[fila-atendimento]
exten => s,1,NoOp(Entrada na fila ATENDIMENTO)
 same => n,Answer()
 same => n,Set(__AUDIOHOOK_INHERIT(MixMonitor)=yes)
 same => n,Set(__RECFILE=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}_${CALLERID(num)}_600)
 same => n,Set(CDR(userfield)=${RECFILE}.wav)
 same => n,MixMonitor(${RECFILE}.wav,b)
 same => n,Queue(atendimento,t)
 same => n,Hangup()



; ==================================================
; CONTEXTO DE CHAMADA DOS AGENTES DA FILA
; ==================================================
[confirmar]
exten => _1XXX,1,NoOp(Chamando agente ${EXTEN} com confirmacao)
 same => n,Dial(PJSIP/${EXTEN},20,U(confirmar-agente))
 same => n,Hangup()



; ==================================================
; CONFIRMAÇÃO POR DTMF (ANTI AUTO-ANSWER)
; ==================================================
[confirmar-agente]
exten => s,1,NoOp(Confirmacao DTMF do agente)
 same => n,Playback(beep)
 same => n,Read(OPCAO,,1,,3,5)
 same => n,GotoIf($["${OPCAO}"="1"]?ok:fail)
 same => n(ok),Return()
 same => n(fail),Hangup()



; ==================================================
; CONTEXTO PARA CHAMADAS EXTERNAS (SEGURANÇA)
; Tudo que vier da internet / IP desconhecido NÃO pode cair em from-internal
; ==================================================
[from-external]
exten => _X.,1,NoOp(BLOCKED EXTERNAL INVITE: src=${CHANNEL(recvip)}:${CHANNEL(recvport)} from=${CALLERID(all)} to=${EXTEN})
 same => n,Hangup(603)
