[general]
static=yes
writeprotect=no
clearglobalvars=no


; ==================================================
; CONTEXTO PRINCIPAL - RAMAIS INTERNOS
; ==================================================
[from-internal]

; ---------- CHAMADAS ENTRE RAMAIS ----------
exten => _1XXX,1,NoOp(Chamada direta para ramal ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},20)
 same => n,Hangup()

; ---------- ACESSO Ã€ FILA ----------
exten => 600,1,Goto(fila-atendimento,s,1)



; ==================================================
; CONTEXTO DA FILA
; ==================================================
[fila-atendimento]
exten => s,1,NoOp(Entrada na fila ATENDIMENTO)
 same => n,Answer()
 same => n,Set(__AUDIOHOOK_INHERIT(MixMonitor)=yes)
 same => n,Set(__RECFILE=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}_${CALLERID(num)}_600)
 same => n,Set(CDR(userfield)=${RECFILE}.wav)
 same => n,MixMonitor(${RECFILE}.wav,b)
 same => n,Queue(atendimento,t)
 same => n,Hangup()



; ==================================================
; CONTEXTO DE CHAMADA DOS AGENTES DA FILA
; ==================================================
[confirmar]
exten => _1XXX,1,NoOp(Chamando agente ${EXTEN} com confirmacao)
 same => n,Dial(PJSIP/${EXTEN},20,U(confirmar-agente))
 same => n,Hangup()



; ==================================================
; CONFIRMAÃ‡ÃƒO POR DTMF (ANTI AUTO-ANSWER)
; ==================================================
[confirmar-agente]
exten => s,1,NoOp(Confirmacao DTMF do agente)
 same => n,Playback(beep)
 same => n,Read(OPCAO,,1,,3,5)
 same => n,GotoIf($["${OPCAO}"="1"]?ok:fail)
 same => n(ok),Return()
 same => n(fail),Hangup()



; ==================================================
; CONTEXTO PARA CHAMADAS EXTERNAS (SEGURANÃ‡A)
; Tudo que vier da internet / IP desconhecido NÃƒO pode cair em from-internal
; ==================================================
[from-external]
exten => _X.,1,NoOp(BLOCKED EXTERNAL INVITE: src=${CHANNEL(recvip)}:${CHANNEL(recvport)} from=${CALLERID(all)} to=${EXTEN})
 same => n,Hangup(603)

[from-twilio]
exten => _+X.,1,NoOp(ğŸ“ Twilio inbound DID=${EXTEN} CID=${CALLERID(num)})
 same => n,Goto(fila-atendimento,s,1)

exten => _X.,1,NoOp(ğŸ“ Twilio inbound DID=${EXTEN} CID=${CALLERID(num)})
 same => n,Goto(fila-atendimento,s,1)


[outbound-twilio]
; Discagem em E.164: 00 + paÃ­s + DDD + nÃºmero (ex: 0055...)
exten => _00X.,1,NoOp(Saida via Twilio: ${EXTEN})
 same => n,Set(NUM=+${EXTEN:2})
 same => n,Dial(PJSIP/${NUM}@twilio-endpoint,60)
 same => n,Hangup()

; Discagem BR sem o + (ex: 55DDDNUMERO)
exten => _55X.,1,NoOp(Saida via Twilio: ${EXTEN})
 same => n,Set(NUM=+${EXTEN})
 same => n,Dial(PJSIP/${NUM}@twilio-endpoint,60)
 same => n,Hangup()
